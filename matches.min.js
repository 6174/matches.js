// matches.js
// ----------
// Powerful pattern matching for Javascript
//
// version : 0.4.0
// author  : Nathan Faubion <nathan@n-son.com>
// license : MIT
(function(){function e(t){return e.modules[t]}e.modules={},e.modules["./parser"]=function(){function n(e){var t=new r(e),n=i(t);return n}function r(e){this.input=e,this.buffer=e,this.pos=0}function i(e){var t=s(e.skipWs());return e.skipWs().buffer&&Ct(e),t}function s(e){return ut(u(e))}function o(e){return L(f,e)}function u(e){return L(a,e,A())}function a(e){return l(e)||f(e)}function f(e){return c(e)||h(e)||p(e)||d(e)||v(e)||m(e)||g(e)||y(e)||b(e)||w(e)||T(e)}function l(e){var t=e.takeAPeek("...");if(t)return at(f(e)||ft())}function c(e){if(e.takeAPeek("_"))return ft()}function h(e){if(e.takeAPeek(U))return lt()}function p(e){if(e.takeAPeek(R))return ct()}function d(e){var t=e.takeAPeek(z);if(t)return ht(t[0])}function v(e){var t=j(e);if(t)return pt(t)}function m(e){var t=O(e);if(t)return dt(t)}function g(e){var t=e.takeAPeek(V);if(t){var n=t[0],r=w(e);return r?Et(n,r):(r=k("(",")",u,vt,e),r?Et(n,r):Et(n))}}function y(e){function n(e){return St(t[1],e)}var t=e.takeAPeek($);if(t)return k("(",")",f,n,e)||St(t[1])}function b(e){return k("[","]",u,vt,e)}function w(e){return k("{","}",E,mt,e)}function E(e){return L(S,e)}function S(e){var t=x(e);if(t){if(e.skipWs().takeAPeek(":")){var n=f(e.skipWs());if(n)return wt(t,n)}return bt(t)}}function x(e){var t=O(e);if(t)return t;var n=e.takeAPeek(X);if(n)return n[0]}function T(e){var t=e.takeAPeek(W);if(t){if(e.takeAPeek("@")){var n=N(e);if(n)return gt(t[0],n)}return yt(t[0])}}function N(e){return g(e)||b(e)||w(e)}function C(e,t,n,r){}function k(e,t,n,r,i){if(i.takeAPeek(e)){var s=n(i.skipWs());if(i.skipWs().takeAPeek(t))return r(s);Ct(i,"Expected "+t)}}function L(e,t,n){var r=[],i;for(;;){i=e(t);if(!(i&&!n||i&&n(i,t)))break;r.push(i);if(!t.skipWs().takeAPeek(","))break;t.skipWs()}return r}function A(){var e=0;return function(t,n){return(t.type==="rest"||t.type==="restIdentifier")&&++e>1&&(n.put(t.pattern),Ct(n,"Multiple ...'s not allowed")),!0}}function O(e){return M('"',J,e)||M("'",K,e)}function M(e,t,n){if(n.takeAPeek(e)){var r=_(t,n);if(n.takeAPeek(e))return r;Ct(n,"Expected "+e)}}function _(e,t){var n="";for(;;){var r=t.takeAPeek(e);if(r)n+=r;else{if(!t.peek("\\"))break;r=D(t);if(!r)break;n+=r}}return n}function D(e){return P(e)||H(et,e)||H(Z,e)||B(e)}function P(e){if(e.takeAPeek(Y))return"\0"}function H(e,t){var n=t.takeAPeek(e);if(n)return String.fromCharCode(parseInt("0x"+n[1]))}function B(e){var t=e.takeAPeek(G);if(t)return t[1].replace("b","\b").replace("f","\f").replace("n","\n").replace("r","\r").replace("t","	").replace("v","");t=e.takeAPeek(Q);if(t)return t[1]}function j(e){var t="";e.takeAPeek("-")&&(t+="-");var n=q(e);return n&&(t+=n),n=F(e),n&&(t+=n),t&&t!=="-"&&(n=I(e),n&&(t+=n)),t==="-"&&Ct(e,"Expected number"),t||null}function F(e){if(e.takeAPeek(".")){var t=e.takeAPeek(it);if(t)return"."+t;Ct(e,"Expected digit")}}function I(e){var t=e.takeAPeek(tt);if(t){var n=e.takeAPeek(it);if(n)return t[0]+n}}function q(e){return e.takeAPeek(rt)||e.takeAPeek(st)}function ot(e,t,n,r){var i={pattern:t,type:e},s=arguments.length;return n!==undefined&&(i.value=n),r!==undefined&&(i.children=r),i}function ut(e){return ot("argumentList",xt(e).join(","),undefined,e)}function at(e){return ot("rest","..."+e.pattern,undefined,[e])}function ft(){return ot("wildcard","_")}function lt(){return ot("null","null")}function ct(){return ot("undefined","undefined")}function ht(e){return ot("boolean",e,e==="true")}function pt(e){return ot("number",e,parseFloat(e))}function dt(e){return ot("string",Tt(e),e)}function vt(e){return ot("array","["+xt(e).join(",")+"]",undefined,e)}function mt(e){return ot("object","{"+xt(e).join(",")+"}",undefined,e)}function gt(e,t){return ot("capture",e+"@"+t.pattern,e,[t])}function yt(e){return ot("identifier",e,e)}function bt(e){return e=Tt(e),ot("key",e,e)}function wt(e,t){return e=Tt(e),ot("keyValue",e+":"+t.pattern,e,[t])}function Et(e,t){var n=e;return t&&(n+=t.type==="array"?"("+t.pattern.substring(1,t.pattern.length-1)+")":t.pattern),ot("class",n,e,t?[t]:undefined)}function St(e,t){return t?ot("extractor","$"+e+"("+t.pattern+")",e,[t]):ot("extractor","$"+e,e)}function xt(e){return e.map(function(e){return e.pattern})}function Tt(e){return'"'+e.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\x08/g,"\\b").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\f/g,"\\f").replace(/\r/g,"\\r").replace(/[\x00-\x07\x0B\x0E-\x1F\x80-\uFFFF]/g,Nt)+'"'}function Nt(e){var t=e.charCodeAt(0),n,r;t<=255?(n="x",r=2):(n="u",r=4);var i=t.toString(16);return"\\"+n+Array(r-i.length).join("0")+i}function Ct(e,t){throw t||(t="Unexpected character"),t+=" at column "+(e.pos+1),new SyntaxError(t+"\n"+e.input+"\n"+Array(e.input.length-e.buffer.length+1).join(" ")+"^")}var e={exports:{}},t=e.exports;t.parse=n,r.prototype.take=function(e){var t=this.buffer.substr(0,e);return this.buffer=this.buffer.substring(e),this.pos+=t.length,t},r.prototype.peek=function(e){return e instanceof RegExp?this.buffer.match(e):this.buffer.substr(0,e.length)===e?e:null},r.prototype.takeAPeek=function(e){var t=this.peek(e);if(t)return this.take((e instanceof RegExp?t[0]:t).length),t},r.prototype.skipWs=function(){while(this.takeAPeek(" "))continue;return this},r.prototype.put=function(e){this.buffer=e+this.buffer;var t=this.pos-e.length;return this.pos=t<0?0:t,this};var R=/^(undefined)\b/,U=/^(null)\b/,z=/^(true|false)\b/,W=/^[a-z][_$a-zA-Z0-9]*/,X=/^[_$a-zA-Z][_$a-zA-Z0-9]*/,V=/^[A-Z][_$a-zA-Z0-9]*/,$=/^\$([_$a-zA-Z][_$a-zA-Z0-9]*)/,J=/^(?!["\\])./,K=/^(?!['\\])./,Q=/^\\(.)/,G=/^\\(['"\\bfnrtv])/,Y=/^\\0(?![0-9])/,Z=/^\\u([0-9a-fA-F]{4})/,et=/^\\x([0-9a-fA-F]{2})/,tt=/^[eE](\+|-)?/,nt=/^[0-9a-fA-F]/,rt=/^[1-9][0-9]+/,it=/^[0-9]+/,st=/^[0-9]/;return e.exports}(),e.modules["./compiler"]=function(){function n(e){var t=["var ret = [];",i(e),"return ret;"];return new Function(["args","runt"],t.join("\n"))}function i(e){return v("args",e)}function s(e,t){return r[t.type](e,t)}function o(){return""}function u(e){return"if ("+e+" !== null) return false;"}function a(e){return"if ("+e+" !== void 0) return false;"}function f(e,t){return"if ("+e+" !== "+t.pattern+") return false;"}function l(e,t){return"if ("+e+" !== "+t.pattern+") return false;"}function c(e,t){return"if ("+e+" !== "+t.pattern+") return false;"}function h(e){return"ret.push("+e+");"}function p(e,t){var n=["ret.push("+e+");",s(e,t.children[0])];return n.join("\n")}function d(e){for(var t=0,n;n=e.children[t];t++)if(n.type==="rest")return!0;return!1}function v(e,t){return d(t)?g(e,t):m(e,t)}function m(e,t){var n=t.children.length,r=["if (!("+e+" instanceof Array) || "+e+".length !== "+n+") return false;"];return t.children.forEach(function(t,n){var i=e+"_"+n;r.push("var "+i+" = "+e+"["+n+"];",s(i,t))}),r.join("\n")}function g(e,t){var n=t.children.length,r=n-1,i=e+"_pos",o=e+"_rest",u=["if (!("+e+" instanceof Array) || "+e+".length < "+r+") return false;","var "+i+" = 0;","var "+o+";"];return t.children.forEach(function(t,n){var a=e+"_"+n;if(t.type==="rest"){n===r?u.push(o+" = "+e+".slice("+n+");"):n===0?u.push(i+" = "+e+".length - "+r+";",o+" = "+e+".slice(0, "+i+");"):u.push(i+" = "+e+".length - "+(r-n)+";",o+" = "+e+".slice("+n+", "+i+");");var f=t.children[0].type;f==="identifier"?u.push("ret.push("+o+");"):f!=="wildcard"&&u.push(x(o,t))}else u.push("var "+a+" = "+e+"["+i+"++];"),u.push(s(a,t))}),u.join("\n")}function y(e,t){var n=e+"_keys",r=e+"_i",i=t.children.map(function(e){return e.value}),o=["if (!("+e+" instanceof Object)) return false;","var "+n+" = ["+i.join(",")+"];","for (var "+r+" = 0; "+r+" < "+i.length+"; "+r+"++) {","if (!("+n+"["+r+"] in "+e+")) return false;","}"];return t.children.forEach(function(t,n){var r=e+"_"+n;t.type==="key"?o.push("ret.push("+e+"["+t.value+"]);"):o.push("var "+r+" = "+e+"["+t.value+"];",s(r,t.children[0]))}),o.join("\n")}function b(e,t){var n=t.children?E:w;return n(e,t)}function w(e,t){return"if (!runt.matchesTypeName("+e+", '"+t.value+"')) return false;"}function E(e,t){var n=t.children[0].type==="array",r=n?"unapply":"unapplyObj",i=n?v:y,s=e+"_vals",o=["if (!("+e+" instanceof Object)) return false;",w(e,t),"if (!"+e+".constructor || !"+e+".constructor."+r+") return false;","var "+s+" = "+e+".constructor."+r+"("+e+");",i(s,t.children[0])];return o.join("\n")}function S(e,t){var n=e+"_ext",r=e+"_val",i=["var "+n+" = runt.callExtractor('"+t.value+"', "+e+");","if (!"+n+" || !("+n+" instanceof runt.Pass)) return false;"];return t.children&&(i.push("var "+r+" = "+n+".val;"),i.push(s(r,t.children[0]))),i.join("\n")}function x(e,t){function h(){var e=[];for(i=0;i<o;i++)e.push(u+"["+i+"].push("+c+"["+i+"]);");return e.join("\n")}var n=[],r=[],i=0,o=T(t);for(;i<o;i++)r.push("[]");var u=e+"_ret",a=e+"_loop",f=e+"_i",l=e+"_len",c=e+"_retargs";return n.push("var "+u+" = ["+r.join(", ")+"];","var "+a+" = function (val) {","var ret = [];",s("val",t.children[0]),"return ret;","};","var "+f+" = 0, "+l+" = "+e+".length, "+c+";","for (; "+f+" < "+l+"; "+f+"++) {",c+" = "+a+"("+e+"["+f+"]);","if (!"+c+") return false;",h(),"}","ret = Array.prototype.concat.call(ret, "+u+");"),n.join("\n")}function T(e){if(!e.children)return 0;var t=0,n=0,r=e.children.length,i;for(;n<r;n++)i=e.children[n].type,i==="identifier"||i==="capture"||i==="key"?t+=1:t+=T(e.children[n]);return t}var e={exports:{}},t=e.exports;t.compile=n;var r={wildcard:o,"null":u,"undefined":a,"boolean":f,number:l,string:c,identifier:h,capture:p,array:v,object:y,"class":b,extractor:S};return e.exports}(),e.modules["./runtime"]=function(){function r(e,t){var r=n.call(e);if(r.substring(8,r.length-1)===t)return!0;if(e.constructor)if(e.constructor.name===t||e.constructor.className===t)return!0;return!1}function s(e,t){if(!i.hasOwnProperty(e))throw new Error("Extractor does not exist: "+e);return i[e](t,o)}function o(e){if(!(this instanceof o))return new o(e);this.val=e}var e={exports:{}},t=e.exports,n=Object.prototype.toString,i={};return t.matchesTypeName=r,t.extractors=i,t.callExtractor=s,t.Pass=o,e.exports}(),e.modules["./matcher"]=function(){function i(e,t,n){this.patternFn=e,this.successFn=t,this.next=n}var t={exports:{}},n=t.exports,r=e("./runtime");return n.Matcher=i,i.prototype.match=function(e,t){var n=this.patternFn(e,r);if(n)return this.successFn.apply(t,n);if(this.next)return this.next.match(e,t);throw new TypeError("All patterns exhausted")},i.prototype.clone=function(){var e=new i(this.patternFn,this.successFn);return this.next&&(e.next=this.next.clone()),e},i.prototype.last=function(){var e=this;while(e.next)e=e.next;return e},i.prototype.pop=function(){var e=this,t;while(e.next)t=e,e=e.next;return t&&(t.next=null),e},t.exports}(),e.modules["./matches"]=function(){function f(){var e=o.call(arguments),t=typeof e[0],n=typeof e[1],s=typeof e[2],c,h,p,d,v,m,g,y;if(t!="function"||n!="undefined"&&n!="object"){if(t!="object"||n!="undefined"&&n!="object")return t=="function"&&n=="function"?(m=e[2]?e[2].clone():null,l(e[0],e[1],m)):(d=e[0],v=e[1],m=e[2]?e[2].clone():null,d in u?p=u[d]:(g=r.parse(d),g.pattern in a?p=u[d]=a[g.pattern]:(p=i.compile(g),p.pattern=g.pattern,u[d]=p,a[g.pattern]=p)),l(p,v,m));h=e[0],m=e[1]?e[1].clone():null;for(d in h)c=f(d,h[d],m),m=c.__matchChain;return c}c=e[0],m=e[1];if(!c.__matchChain)throw new Error("Not a matcher function");return m?(m=m.clone(),m.last().next=c.__matchChain.clone()):m=c.__matchChain.clone(),y=m.pop(),l(y.patternFn,y.successFn,m)}function l(e,t,n){var r=new s(e,t);n?n.last().next=r:n=r;var i=function(){var e=o.call(arguments);return n.match(e,this)};return i.alt=function(){var e=o.call(arguments);return e.push(n),f.apply(null,e)},i.__matchChain=n,i}function c(){var e=o.call(arguments,0,-1),t=arguments[arguments.length-1],r=this===n?null:this;if(typeof t=="function"){if(!t.__matchChain)throw new Error("Not a matcher function");return t.apply(r,e)}return f(t).apply(r,e)}function h(){var e=o.call(arguments,1),t=this===n?null:this,r=f(arguments[0],d).alt(v,p);return r.apply(t,e)}function p(){return null}function d(){return o.call(arguments,0)}function v(){return[]}var t={exports:{}},n=t.exports,r=e("./parser"),i=e("./compiler"),s=e("./matcher").Matcher,o=Array.prototype.slice,u={},a={};return n.pattern=f,n.caseOf=c,n.extract=h,n.parser=r,n.compiler=i,n.extractors=e("./runtime").extractors,t.exports}(),window.matches=e("./matches")})();