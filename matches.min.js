// matches.js
// ----------
// Powerful pattern matching for Javascript
//
// version : 0.3.1
// author  : Nathan Faubion <nathan@n-son.com>
// license : MIT
(function(){function require(e){return require.modules[e]}require.modules={},require.modules["./parser"]=function(){function parse(e){var t=new Input(e),n=start(t);return n}function Input(e){this.input=e,this.buffer=e,this.pos=0}function start(e){var t=argumentList(e.skipWs());return e.skipWs().buffer&&syntaxError(e),t}function argumentList(e){return nodeArgumentList(patterns(e))}function patterns(e){return commaSeparated(pattern,e)}function restPatterns(e){return commaSeparated(restPattern,e,multiRestCallback())}function restPattern(e){return rest(e)||pattern(e)}function pattern(e){return wildcard(e)||nullLiteral(e)||undefinedLiteral(e)||booleanLiteral(e)||numberLiteral(e)||stringLiteral(e)||classPattern(e)||array(e)||object(e)||identPattern(e)}function rest(e){var t=e.takeAPeek(o);if(t)return nodeRestIdentifier(t[1]);var n=e.takeAPeek("...");if(n)return nodeRest(n)}function wildcard(e){if(e.takeAPeek("_"))return nodeWildcard()}function nullLiteral(e){if(e.takeAPeek(r))return nodeNullLiteral()}function undefinedLiteral(e){if(e.takeAPeek(n))return nodeUndefinedLiteral()}function booleanLiteral(e){var t=e.takeAPeek(i);if(t)return nodeBooleanLiteral(t[0])}function numberLiteral(e){var t=number(e);if(t)return nodeNumberLiteral(t)}function stringLiteral(e){var t=string(e);if(t)return nodeStringLiteral(t)}function classPattern(e){var t=e.takeAPeek(a);if(t){var n=object(e);return n?nodeClassObject(t[0],n):(n=series("(",")",restPatterns,nodeArray,e),n?nodeClassArray(t[0],n):nodeClassName(t[0]))}}function array(e){return series("[","]",restPatterns,nodeArray,e)}function object(e){return series("{","}",objectPatterns,nodeObject,e)}function objectPatterns(e){return commaSeparated(objectPattern,e,multiRestCallback())}function objectPattern(e){var t=rest(e);if(t)return t;t=key(e);if(t){if(e.skipWs().takeAPeek(":")){var n=pattern(e.skipWs());if(n)return nodeKeyValue(t,n)}return nodeKey(t)}}function key(e){var t=string(e);if(t)return t;var n=e.takeAPeek(u);if(n)return n[0]}function identPattern(e){var t=e.takeAPeek(s);if(t){if(e.takeAPeek("@")){var n=capturePattern(e);if(n)return nodeCapture(t[0],n)}return nodeIdentifier(t[0])}}function capturePattern(e){return classPattern(e)||array(e)||object(e)}function series(e,t,n,r,i){if(i.takeAPeek(e)){var s=n(i.skipWs());if(i.skipWs().takeAPeek(t))return r(s);syntaxError(i,"Expected "+t)}}function commaSeparated(e,t,n){var r=[],i;for(;;){i=e(t);if(!(i&&!n||i&&n(i,t)))break;r.push(i);if(!t.skipWs().takeAPeek(","))break;t.skipWs()}return r}function multiRestCallback(){var e=0;return function(t,n){return(t.type==="rest"||t.type==="restIdentifier")&&++e>1&&(n.put(t.pattern),syntaxError(n,"Multiple ...'s not allowed")),!0}}function string(e){return quotedString('"',f,e)||quotedString("'",l,e)}function quotedString(e,t,n){if(n.takeAPeek(e)){var r=quotedStringChars(t,n);if(n.takeAPeek(e))return r;syntaxError(n,"Expected "+e)}}function quotedStringChars(e,t){var n="";for(;;){var r=t.takeAPeek(e);if(r)n+=r;else{if(!t.peek("\\"))break;r=escapeSeq(t);if(!r)break;n+=r}}return n}function escapeSeq(e){return nullEscapeSeq(e)||specialEscapeSeq(v,e)||specialEscapeSeq(d,e)||charEscapeSeq(e)}function nullEscapeSeq(e){if(e.takeAPeek(p))return"\0"}function specialEscapeSeq(e,t){var n=t.takeAPeek(e);if(n)return String.fromCharCode(parseInt("0x"+n[1]))}function charEscapeSeq(e){var t=e.takeAPeek(h);if(t)return t[1].replace("b","\b").replace("f","\f").replace("n","\n").replace("r","\r").replace("t","	").replace("v","");t=e.takeAPeek(c);if(t)return t[1]}function number(e){var t="";e.takeAPeek("-")&&(t+="-");var n=integer(e);return n&&(t+=n),n=fraction(e),n&&(t+=n),t&&t!=="-"&&(n=exponent(e),n&&(t+=n)),t==="-"&&syntaxError(e,"Expected number"),t||null}function fraction(e){if(e.takeAPeek(".")){var t=e.takeAPeek(b);if(t)return"."+t;syntaxError(e,"Expected digit")}}function exponent(e){var t=e.takeAPeek(m);if(t){var n=e.takeAPeek(b);if(n)return t[0]+n}}function integer(e){return e.takeAPeek(y)||e.takeAPeek(w)}function node(e,t,n,r){var i={pattern:t,type:e},s=arguments.length;return n!==undefined&&(i.value=n),r!==undefined&&(i.children=r),i}function nodeArgumentList(e){return node("argumentList",patternStrings(e).join(","),e)}function nodeRest(e){return node("rest","...")}function nodeRestIdentifier(e){return node("restIdentifier",e+"...",e)}function nodeWildcard(){return node("wildcard","_")}function nodeNullLiteral(){return node("null","null")}function nodeUndefinedLiteral(){return node("undefined","undefined")}function nodeBooleanLiteral(e){return node("boolean",e,e==="true")}function nodeNumberLiteral(e){return node("number",e,parseFloat(e))}function nodeStringLiteral(e){return node("string",quote(e),e)}function nodeClassName(e){return node("className",e,e)}function nodeClassArray(e,t){return node("classArray",e+t.pattern,e,t.children)}function nodeClassObject(e,t){return node("classObject",e+t.pattern,e,t.children)}function nodeArray(e){return node("array","["+patternStrings(e).join(",")+"]",undefined,e)}function nodeObject(e){return node("object","{"+patternStrings(e).join(",")+"}",undefined,e)}function nodeCapture(e,t){return node("capture",e+"@"+t.pattern,e,[t])}function nodeIdentifier(e){return node("identifier",e,e)}function nodeKey(e){return e=quote(e),node("key",e,e)}function nodeKeyValue(e,t){return e=quote(e),node("keyValue",e+":"+t.pattern,e,[t])}function patternStrings(e){return e.map(function(e){return e.pattern})}function quote(e){return'"'+e.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\x08/g,"\\b").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\f/g,"\\f").replace(/\r/g,"\\r").replace(/[\x00-\x07\x0B\x0E-\x1F\x80-\uFFFF]/g,escape)+'"'}function escape(e){var t=e.charCodeAt(0),n,r;t<=255?(n="x",r=2):(n="u",r=4);var i=t.toString(16);return"\\"+n+Array(r-i.length).join("0")+i}function syntaxError(e,t){throw t||(t="Unexpected character"),t+=" at column "+(e.pos+1),new SyntaxError(t+"\n"+e.input+"\n"+Array(e.input.length-e.buffer.length+1).join(" ")+"^")}var e={exports:{}},t=e.exports;t.parse=parse,Input.prototype.take=function(e){var t=this.buffer.substr(0,e);return this.buffer=this.buffer.substring(e),this.pos+=t.length,t},Input.prototype.peek=function(e){return e instanceof RegExp?this.buffer.match(e):this.buffer.substr(0,e.length)===e?e:null},Input.prototype.takeAPeek=function(e){var t=this.peek(e);if(t)return this.take((e instanceof RegExp?t[0]:t).length),t},Input.prototype.skipWs=function(){while(this.takeAPeek(" "))continue;return this},Input.prototype.put=function(e){this.buffer=e+this.buffer;var t=this.pos-e.length;return this.pos=t<0?0:t,this};var n=/^(undefined)\b/,r=/^(null)\b/,i=/^(true|false)\b/,s=/^[a-z][_$a-zA-Z0-9]*/,o=/^([a-z][_$a-zA-Z0-9]*)\.\.\./,u=/^[_$a-zA-Z][_$a-zA-Z0-9]*/,a=/^[A-Z][_$a-zA-Z0-9]*/,f=/^(?!["\\])./,l=/^(?!['\\])./,c=/^\\(.)/,h=/^\\(['"\\bfnrtv])/,p=/^\\0(?![0-9])/,d=/^\\u([0-9a-fA-F]{4})/,v=/^\\x([0-9a-fA-F]{2})/,m=/^[eE](\+|-)?/,g=/^[0-9a-fA-F]/,y=/^[1-9][0-9]+/,b=/^[0-9]+/,w=/^[0-9]/;return e.exports}(),require.modules["./compiler"]=function(){function compile(e){var t=["var ret = [];",compileArgumentList(e),"return ret;"];return new Function(["args","runt"],t.join("\n"))}function compileArgumentList(e){var t=[];for(var n=0,r=e.value.length,i;n<r;n++)i="arg_"+n,t.push("var "+i+" = args["+n+"];",compilePattern(i,e.value[n]));return t.join("\n")}function compilePattern(e,t){return n[t.type](e,t)}function compileWildcard(){return""}function compileNull(e){return"if ("+e+" !== null) return false;"}function compileUndefined(e){return"if ("+e+" !== void 0) return false;"}function compileBoolean(e,t){return"if ("+e+" !== "+t.pattern+") return false;"}function compileNumber(e,t){return"if ("+e+" !== "+t.pattern+") return false;"}function compileString(e,t){return"if ("+e+" !== "+t.pattern+") return false;"}function compileIdentifier(e){return"ret.push("+e+");"}function compileClassName(e,t){return"if (!runt.matchesTypeName("+e+", '"+t.value+"')) return false;"}function compileCapture(e,t){var n=["ret.push("+e+");",compilePattern(e,t.children[0])];return n.join("\n")}function hasRest(e){for(var t=0,n;n=e.children[t];t++)if(n.type==="rest"||n.type==="restIdentifier")return!0;return!1}function compileArray(e,t){return hasRest(t)?compileArrayRest(e,t):compileArrayStrict(e,t)}function compileArrayStrict(e,t){var n=t.children.length,r=["if (!("+e+" instanceof Array) || "+e+".length !== "+n+") return false;"];return t.children.forEach(function(t,n){var i=e+"_"+n;r.push("var "+i+" = "+e+"["+n+"];",compilePattern(i,t))}),r.join("\n")}function compileArrayRest(e,t){var n=t.children.length,r=n-1,i=e+"_pos",s=["if (!("+e+" instanceof Array) || "+e+".length < "+r+") return false;","var "+i+" = 0;"];return t.children.forEach(function(t,n){var o=e+"_"+n,u=t.type==="restIdentifier";u||t.type==="rest"?n===r&&u?s.push("ret.push("+e+".slice("+n+"));"):n===0?(s.push(i+" = "+e+".length - "+r+";"),u&&s.push("ret.push("+e+".slice(0, "+i+"));")):(s.push(i+" = "+e+".length - "+(r-n)+";"),u&&s.push("ret.push("+e+".slice("+n+", "+i+"));")):(s.push("var "+o+" = "+e+"["+i+"++];"),s.push(compilePattern(o,t)))}),s.join("\n")}function compileObject(e,t){return hasRest(t)?compileObjectRest(e,t):compileObjectStrict(e,t)}function compileObjectStrict(e,t){var n=e+"_keys",r=e+"_count",i=e+"_i",s=t.children.map(function(e){return e.value+":1"}),o=["if (!("+e+" instanceof Object)) return false;","var "+n+" = {"+s.join(",")+"};","var "+r+" = 0;","for (var "+i+" in "+e+") {","if (!("+n+".hasOwnProperty("+i+"))) return false;","else "+r+" += 1;","}","if ("+r+" !== "+t.children.length+") return false;"];return t.children.forEach(function(t,n){var r=e+"_"+n;t.type==="key"?o.push("ret.push("+e+"["+t.value+"]);"):o.push("var "+r+" = "+e+"["+t.value+"];",compilePattern(r,t.children[0]))}),o.join("\n")}function compileObjectRest(e,t){var n=e+"_keys",r=e+"_count",i=e+"_rest",s=e+"_i",o=t.children.length-1,u=!1,a=[];t.children.forEach(function(e){e.type==="restIdentifier"?u=!0:e.type!=="rest"&&a.push(e.value+":1")});var f=["if (!("+e+" instanceof Object)) return false;","var "+n+" = {"+a.join(",")+"};","var "+r+" = 0;"];return u&&f.push("var "+i+" = {};"),f.push("for (var "+s+" in "+e+") {"),u?f.push("if (!("+n+".hasOwnProperty("+s+"))) "+i+"["+s+"] = "+e+"["+s+"];","else "+r+" += 1;"):f.push("if ("+n+".hasOwnProperty("+s+")) "+r+" += 1;"),f.push("}","if ("+r+" !== "+o+") return false;"),t.children.forEach(function(t,n){var r=e+"_"+n;t.type==="key"?f.push("ret.push("+e+"["+t.value+"]);"):t.type==="keyValue"?f.push("var "+r+" = "+e+"["+t.value+"];",compilePattern(r,t.children[0])):t.type==="restIdentifier"&&f.push("ret.push("+i+");")}),f.join("\n")}function compileClassArray(e,t){var n=e+"_vals",r=["if (!("+e+" instanceof Object)) return false;",compileClassName(e,t),"if (!"+e+".constructor || !"+e+".constructor.unapply) return false;","var "+n+" = "+e+".constructor.unapply("+e+");",compileArray(n,t)];return r.join("\n")}function compileClassObject(e,t){var n=e+"_vals",r=["if (!("+e+" instanceof Object)) return false;",compileClassName(e,t),"if (!"+e+".constructor || !"+e+".constructor.unapplyObj) return false;","var "+n+" = "+e+".constructor.unapplyObj("+e+");",compileObject(n,t)];return r.join("\n")}var e={exports:{}},t=e.exports;t.compile=compile;var n={wildcard:compileWildcard,"null":compileNull,"undefined":compileUndefined,"boolean":compileBoolean,number:compileNumber,string:compileString,identifier:compileIdentifier,array:compileArray,object:compileObject,classArray:compileClassArray,classObject:compileClassObject,className:compileClassName,capture:compileCapture};return e.exports}(),require.modules["./runtime"]=function(){function matchesTypeName(e,t){var r=n.call(e);if(r.substring(8,r.length-1)===t)return!0;if(e.constructor)if(e.constructor.name===t||e.constructor.className===t)return!0;return!1}var e={exports:{}},t=e.exports,n=Object.prototype.toString;return t.matchesTypeName=matchesTypeName,e.exports}(),require.modules["./matcher"]=function(){function Matcher(e,t,n){this.patternFn=e,this.successFn=t,this.next=n}var e={exports:{}},t=e.exports,n=require("./runtime");return t.Matcher=Matcher,Matcher.prototype.match=function(e,t){var r=this.patternFn(e,n);if(r)return this.successFn.apply(t,r);if(this.next)return this.next.match(e,t);throw new TypeError("All patterns exhausted")},Matcher.prototype.clone=function(){var e=new Matcher(this.patternFn,this.successFn);return this.next&&(e.next=this.next.clone()),e},Matcher.prototype.last=function(){var e=this;while(e.next)e=e.next;return e},Matcher.prototype.pop=function(){var e=this,t;while(e.next)t=e,e=e.next;return t&&(t.next=null),e},e.exports}(),require.modules["./matches"]=function(){function pattern(){var e=s.call(arguments),t=typeof e[0],i=typeof e[1],a=typeof e[2],f,l,c,h,p,d,v,m;if(t!="function"||i!="undefined"&&i!="object"){if(t!="object"||i!="undefined"&&i!="object")return t=="function"&&i=="function"?(d=e[2]?e[2].clone():null,matcher(e[0],e[1],d)):(h=e[0],p=e[1],d=e[2]?e[2].clone():null,h in o?c=o[h]:(v=n.parse(h),v.pattern in u?c=o[h]=u[v.pattern]:(c=r.compile(v),c.pattern=v.pattern,o[h]=c,u[v.pattern]=c)),matcher(c,p,d));l=e[0],d=e[1]?e[1].clone():null;for(h in l)f=pattern(h,l[h],d),d=f.__matchChain;return f}f=e[0],d=e[1];if(!f.__matchChain)throw new Error("Not a matcher function");return d?(d=d.clone(),d.last().next=f.__matchChain.clone()):d=f.__matchChain.clone(),m=d.pop(),matcher(m.patternFn,m.successFn,d)}function matcher(e,t,n){var r=new i(e,t);n?n.last().next=r:n=r;var o=function(){var e=s.call(arguments);return n.match(e,this)};return o.alt=function(){var e=s.call(arguments);return e.push(n),pattern.apply(null,e)},o.__matchChain=n,o}function caseOf(){var e=s.call(arguments,0,-1),n=arguments[arguments.length-1],r=this===t?null:this;if(typeof n=="function"){if(!n.__matchChain)throw new Error("Not a matcher function");return n.apply(r,e)}return pattern(n).apply(r,e)}var e={exports:{}},t=e.exports,n=require("./parser"),r=require("./compiler"),i=require("./matcher").Matcher,s=Array.prototype.slice,o={},u={};return t.pattern=pattern,t.caseOf=caseOf,t.parser=n,t.compiler=r,e.exports}(),window.matches=require("./matches")})();